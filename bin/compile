#!/bin/bash
# usage: bin/compile <build-dir> <cache-dir>
BP=$(dirname $(dirname $0))
source $BP/bin/functions.sh

if [[ -z "${1:-}" ]]; then
	err "Missing argument <build-dir>"
fi
BUILDDIR=$(cd "${1:-}/" && pwd)

if [[ -z "${2:-}" ]]; then
	err "Missing argument <cache-dir>"
fi
CACHEDIR=$(cd "${2:-}" && pwd)

if [[ ! -f "${BUILDDIR}/Logstash" ]]; then
	err "${BUILDDIR}/Logstash not found."
fi

# Source ubuntu distribution information
if [[ -f "/etc/lsb-release" ]]; then
	source /etc/lsb-release
fi

source ${BUILDDIR}/Logstash

# Default Values
LOGSTASH_CMD_ARGS=${LOGSTASH_CMD_ARGS:-""}
LOGSTASH_PLUGINS=${LOGSTASH_PLUGINS:-()}
LOGSTASH_CONFIG_CHECK=${LOGSTASH_CONFIG_CHECK:-1}
LOGSTASH_VERSION=${LOGSTASH_VERSION:-$(cat ${BP}/VERSION)}
LOGSTASH_FILE=${LOGSTASH_FILE:-"logstash-${LOGSTASH_VERSION}.tar.gz"}
LOGSTASH_URL=${LOGSTASH_URL:-"https://download.elastic.co/logstash/logstash/${LOGSTASH_FILE}"}
SHA1_EXT=${SHA1_EXT:-".sha1.txt"}
OPENJDK_VERSION=${OPENJDK_VERSION:-"1.8.0_101"}
OPENJDK_URL=${OPENJDK_URL:-"https://java-buildpack.cloudfoundry.org/openjdk-jdk/${DISTRIB_CODENAME:-trusty}/x86_64/openjdk-${OPENJDK_VERSION}.tar.gz"}
DOCKERIZE_VERSION=${DOCKERIZE_VERSION:-"v0.2.1-jsonQuery-templateDirs"}
DOCKERIZE_URL=${DOCKERIZE_URL:-"https://github.com/breml/dockerize/releases/download/v0.2.1-jsonQuery%2BtemplateDirs/dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz"}
JQ_URL=${JQ_URL:-"https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64"}

mkdir -p ${BUILDDIR}/bin

if [[ ! -f ${BUILDDIR}/bin/dockerize ]]; then
	start "Installing dockerize"
	cd ${BUILDDIR}/bin
	${CURL} ${DOCKERIZE_URL} | tar zxf -
	finished
	step "downloaded ${DOCKERIZE_URL}"
fi

if [[ ! -f ${BUILDDIR}/bin/jq ]]; then
	start "Installing jq"
	${CURL} -o ${BUILDDIR}/bin/jq ${JQ_URL}
	chmod +x ${BUILDDIR}/bin/jq
	finished
	step "downloaded ${JQ_URL}"
fi

if [[ ! -d ${BUILDDIR}/openjdk ]]; then
	start "Installing openjdk"
	mkdir -p ${BUILDDIR}/openjdk
	cd ${BUILDDIR}/openjdk
	${CURL} ${OPENJDK_URL} | tar zxf -
	finished
	step "downloaded ${OPENJDK_URL}"
fi

if [[ ! -d ${BUILDDIR}/logstash-${LOGSTASH_VERSION} ]]; then
	start "Installing Logstash ${LOGSTASH_VERSION}"
	${CURL} -o "${CACHEDIR}/${LOGSTASH_FILE}" "${LOGSTASH_URL}"

	${CURL} -o "${CACHEDIR}/${LOGSTASH_FILE}${SHA1_EXT}" "${LOGSTASH_URL}${SHA1_EXT}"
	cd ${CACHEDIR}
	sha1sum --check ${CACHEDIR}/${LOGSTASH_FILE}${SHA1_EXT} >&3

	tar -zx -C ${BUILDDIR} -f ${CACHEDIR}/${LOGSTASH_FILE}
	finished
	step "downloaded ${LOGSTASH_URL}"
fi

export JAVA_HOME="${BUILDDIR}/openjdk"
export LS_HEAP_SIZE="$(echo ${VCAP_APPLICATION} | ${BUILDDIR}/bin/jq '.limits.mem * .9 | floor')m"

# Install Logstash Plugins
if [[ -n ${LOGSTASH_PLUGINS:-""} ]]; then
		step "Installing Logstash Plugins"
		LOGSTASH_PLUGIN_CMD="logstash-plugin"
		if [[ ! -x ${BUILDDIR}/logstash-${LOGSTASH_VERSION}/bin/${LOGSTASH_PLUGIN_CMD} ]]; then
			LOGSTASH_PLUGIN_CMD="plugin"
		fi
        for PLUGIN in "${LOGSTASH_PLUGINS[@]}"; do
                start "Installing Logstash Plugin ${PLUGIN}"
                ${BUILDDIR}/logstash-${LOGSTASH_VERSION}/bin/${LOGSTASH_PLUGIN_CMD} install ${PLUGIN} >&3
                finished
        done
fi

# Logstash config check
if [[ ${LOGSTASH_CONFIG_CHECK} -eq 1 ]]; then
	mkdir -p ${CACHEDIR}/logstash.conf.d

	start "Check Logstash configuration"
	${BUILDDIR}/bin/dockerize -template ${BUILDDIR}/conf.d:${CACHEDIR}/logstash.conf.d ${BUILDDIR}/logstash-${LOGSTASH_VERSION}/bin/logstash -f ${CACHEDIR}/logstash.conf.d -t >&3
	finished
fi

mkdir ${BUILDDIR}/logstash.conf.d

cat << EOF >> ${BUILDDIR}/buildpack-release-step.yml
---
default_process_types:
  web: dockerize -template conf.d:logstash.conf.d logstash-${LOGSTASH_VERSION}/bin/logstash -f logstash.conf.d ${LOGSTASH_CMD_ARGS}
EOF

mkdir -p ${BUILDDIR}/.profile.d
echo 'JAVA_HOME=$HOME/openjdk' > ${BUILDDIR}/.profile.d/openjdk.sh
echo 'PATH=$PATH:$HOME/bin:$HOME/openjdk/bin' > ${BUILDDIR}/.profile.d/path.sh
echo "LS_HEAP_SIZE=$(echo ${LS_HEAP_SIZE})" > ${BUILDDIR}/.profile.d/logstash.sh