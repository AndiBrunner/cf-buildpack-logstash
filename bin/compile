#!/bin/bash
# usage: bin/compile <build-dir> <cache-dir>
set -euo pipefail # Enable bash strict mode (http://redsymbol.net/articles/unofficial-bash-strict-mode/)
#set -x # debug

if [[ -f "/etc/lsb-release" ]]; then
	source /etc/lsb-release
fi

BP=$(dirname $(dirname $0))
LOGSTASH_VERSION=`cat ${BP}/VERSION`
LOGSTASH_FILE="logstash-${LOGSTASH_VERSION}.tar.gz"
LOGSTASH_URL="https://download.elastic.co/logstash/logstash/${LOGSTASH_FILE}"
SHA1_EXT=".sha1.txt"
OPENJDK_VERSION="1.7.0_51"
OPENJDK_URL="https://java-buildpack.cloudfoundry.org/openjdk-jdk/${DISTRIB_CODENAME:-trusty}/x86_64/openjdk-${OPENJDK_VERSION}.tar.gz"
DOCKERIZE_VERSION="v0.2.1-jsonQuery"
DOCKERIZE_URL="https://github.com/breml/dockerize/releases/download/v0.2.1-jsonQuery/dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz"

source $BP/bin/functions.sh

if [[ -z "${1:-}" ]]; then
	err "Missing argument <build-dir>"
	exit 1
fi
BUILDDIR=$(cd "${1:-}/" && pwd)

if [[ -z "${2:-}" ]]; then
	err "Missing argument <cache-dir>"
	exit 1
fi
CACHEDIR=$(cd "${2:-}" && pwd)

if [[ ! -f "${BUILDDIR}/Logstash" ]]; then
	err "${BUILDDIR}/Logstash not found."
	exit 1;
fi

if [[ ! -f ${BUILDDIR}/dockerize ]]; then
	start "Installing dockerize"
	mkdir ${BUILDDIR}/bin
	cd ${BUILDDIR}/bin
	${CURL} ${DOCKERIZE_URL} | tar zxf -
	finished
	echo "downloaded ${DOCKERIZE_URL}"
fi

if [[ ! -d ${BUILDDIR}/openjdk ]]; then
	start "Installing openjdk"
	mkdir -p ${BUILDDIR}/openjdk
	cd ${BUILDDIR}/openjdk
	${CURL} ${OPENJDK_URL} | tar zxf -
	finished
	echo "downloaded ${OPENJDK_URL}"
fi

if [[ ! -d ${BUILDDIR}/logstash-${LOGSTASH_VERSION} ]]; then
	start "Installing Logstash ${LOGSTASH_VERSION}"
	${CURL} -o ${CACHEDIR}/${LOGSTASH_FILE} ${LOGSTASH_URL}
	# Validate SHA1
	${CURL} -o ${CACHEDIR}/${LOGSTASH_FILE}${SHA1_EXT} ${LOGSTASH_URL}${SHA1_EXT}
	sha1sum --check ${CACHEDIR}/${LOGSTASH_FILE}${SHA1_EXT}
	tar -zx -C ${BUILDDIR} -f ${CACHEDIR}/${LOGSTASH_FILE}
	finished
	echo "downloaded ${LOGSTASH_URL}"
fi

mkdir -p ${CACHEDIR}/conf.d

export JAVA_HOME="${BUILDDIR}/openjdk"
start "Check Logstash configuration"
${BUILDDIR}/bin/dockerize -template ${BUILDDIR}/logstash.conf:${CACHEDIR}/conf.d/logstash.conf ${BUILDDIR}/logstash-${LOGSTASH_VERSION}/bin/logstash -f ${CACHEDIR}/conf.d/logstash.conf -t >/dev/null
finished

mkdir ${BUILDDIR}/conf.d

cat << EOF >> ${BUILDDIR}/buildpack-release-step.yml
---
default_process_types:
  web: dockerize -template logstash.conf:conf.d/logstash.conf logstash-${LOGSTASH_VERSION}/bin/logstash -f conf.d/logstash.conf
EOF

mkdir -p ${BUILDDIR}/.profile.d
echo 'JAVA_HOME=$HOME/openjdk' > ${BUILDDIR}/.profile.d/openjdk.sh
echo 'PATH=$PATH:$HOME/bin:$HOME/openjdk/bin' > ${BUILDDIR}/.profile.d/path.sh
